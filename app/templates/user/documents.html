{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <h2>My Documents</h2>
        <p class="text-muted">Manage your vehicle documents and certificates</p>
    </div>
</div>

<div class="row mt-4">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5>Your Documents</h5>
                <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#uploadDocumentModal">
                    <i class="fas fa-plus"></i> Upload Document
                </button>
            </div>
            <div class="card-body">
                {% if documents %}
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Document Type</th>
                                    <th>File Name</th>
                                    <th>Vehicle</th>
                                    <th>Expiry Date</th>
                                    <th>Uploaded Date</th>
                                    <th>Verified</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for document in documents %}
                                <tr>
                                    <td>
                                        <span class="badge bg-{{ 'primary' if document.document_type == 'rc' else 'success' if document.document_type == 'insurance' else 'warning' if document.document_type == 'puc' else 'info' if document.document_type == 'cng_certificate' else 'secondary' }}">
                                            {{ document.document_type|upper }}
                                        </span>
                                    </td>
                                    <td>{{ document.document_name }}</td>
                                    <td>
                                        {% if document.vehicle %}
                                            {{ document.vehicle.vehicle_number }}
                                        {% else %}
                                            <em>General</em>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if document.expiry_date %}
                                            {{ document.expiry_date.strftime('%Y-%m-%d') }}
                                            {% if document.expiry_date < current_user.created_at.date() %}
                                                <span class="badge bg-danger">Expired</span>
                                            {% elif (document.expiry_date - current_user.created_at.date()).days <= 30 %}
                                                <span class="badge bg-warning">Expiring Soon</span>
                                            {% endif %}
                                        {% else %}
                                            <em>No expiry</em>
                                        {% endif %}
                                    </td>
                                    <td>{{ document.uploaded_at.strftime('%Y-%m-%d') }}</td>
                                    <td>
                                        {% if document.is_verified %}
                                            <span class="badge bg-success">Verified</span>
                                        {% else %}
                                            <span class="badge bg-secondary">Pending</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <a href="{{ url_for('main.uploaded_file', filename=document.file_path.replace('app/uploads/', '')) }}" class="btn btn-sm btn-outline-primary" target="_blank">
                                            <i class="fas fa-download"></i> View
                                        </a>
                                        <a href="#" class="btn btn-sm btn-outline-danger" onclick="deleteDocument({{ document.id }})">
                                            <i class="fas fa-trash"></i>
                                        </a>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <p class="text-muted">No documents uploaded yet.</p>
                {% endif %}
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5>Document Guide</h5>
            </div>
            <div class="card-body">
                <p>Upload important documents for your vehicles:</p>
                <ul>
                    <li><strong>RC Book:</strong> Vehicle registration certificate</li>
                    <li><strong>Insurance:</strong> Valid insurance certificate</li>
                    <li><strong>PUC:</strong> Pollution under control certificate</li>
                    <li><strong>CNG Certificate:</strong> CNG installation certificate</li>
                </ul>
                <p>Supported formats: PDF, JPG, PNG, DOC, DOCX</p>
                <p>Max file size: 10MB</p>
            </div>
        </div>
        
        <div class="card mt-4">
            <div class="card-header">
                <h5>Expiring Documents</h5>
            </div>
            <div class="card-body">
                {% set expiring_docs = [] %}
                {% for doc in documents %}
                    {% if doc.expiry_date and doc.expiry_date > current_user.created_at.date() and (doc.expiry_date - current_user.created_at.date()).days <= 30 %}
                        {% if expiring_docs.append(doc) %}{% endif %}
                    {% endif %}
                {% endfor %}
                {% if expiring_docs %}
                    <ul class="list-group list-group-flush">
                        {% for doc in expiring_docs %}
                        <li class="list-group-item">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <strong>{{ doc.document_type|upper }}</strong><br>
                                    <small>{{ doc.document_name }}</small>
                                </div>
                                <div class="text-end">
                                    <span class="badge bg-warning">{{ (doc.expiry_date - current_user.created_at.date()).days }} days</span>
                                </div>
                            </div>
                        </li>
                        {% endfor %}
                    </ul>
                {% else %}
                    <p class="text-muted">No documents expiring soon.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Upload Document Modal -->
<div class="modal fade" id="uploadDocumentModal" tabindex="-1" aria-labelledby="uploadDocumentModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="uploadDocumentModalLabel">Upload Document</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="POST" action="{{ url_for('user.upload_document') }}" enctype="multipart/form-data">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="document_type" class="form-label">Document Type</label>
                        <select class="form-control" id="document_type" name="document_type" required>
                            <option value="">Select Document Type</option>
                            <option value="rc">RC Book</option>
                            <option value="insurance">Insurance</option>
                            <option value="puc">PUC Certificate</option>
                            <option value="cng_certificate">CNG Certificate</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="vehicle_id" class="form-label">Associated Vehicle (Optional)</label>
                        <select class="form-control" id="vehicle_id" name="vehicle_id">
                            <option value="">Select Vehicle (Optional)</option>
                            {% for vehicle in current_user.vehicles %}
                            <option value="{{ vehicle.id }}">{{ vehicle.vehicle_number }} - {{ vehicle.owner_name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="document_file" class="form-label">Select File</label>
                        <input type="file" class="form-control" id="document_file" name="document_file" accept=".pdf,.jpg,.jpeg,.png,.doc,.docx" required>
                    </div>
                    <div class="mb-3">
                        <label for="notes" class="form-label">Notes (Optional)</label>
                        <textarea class="form-control" id="notes" name="notes" rows="2"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-primary">Upload Document</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function deleteDocument(docId) {
    if (confirm('Are you sure you want to delete this document?')) {
        // In a real implementation, you would make an AJAX call to delete the document
        alert('Document deletion would happen here in a full implementation');
    }
}
</script>
{% endblock %}