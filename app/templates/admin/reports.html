{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <h2>Reports & Analytics</h2>
        <p class="text-muted">Platform analytics and compliance reports</p>
    </div>
</div>

<div class="row mt-4">
    <div class="col-md-3">
        <div class="card text-white bg-primary">
            <div class="card-body text-center">
                <i class="fas fa-chart-bar fa-3x mb-2"></i>
                <h5>{{ total_users }}</h5>
                <p class="card-text">Total Users</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-white bg-success">
            <div class="card-body text-center">
                <i class="fas fa-car fa-3x mb-2"></i>
                <h5>{{ total_vehicles }}</h5>
                <p class="card-text">Total Vehicles</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-white bg-info">
            <div class="card-body text-center">
                <i class="fas fa-gas-pump fa-3x mb-2"></i>
                <h5>{{ total_stations }}</h5>
                <p class="card-text">Fuel Stations</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-white bg-warning">
            <div class="card-body text-center">
                <i class="fas fa-clipboard-check fa-3x mb-2"></i>
                <h5>{{ total_compliance_checks or 0 }}</h5>
                <p class="card-text">Compliance Checks</p>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5>Compliance Overview</h5>
                <div>
                    <button class="btn btn-sm btn-outline-primary" onclick="exportCSV()">Export CSV</button>
                    <button class="btn btn-sm btn-outline-danger" onclick="exportPDF()">Export PDF</button>
                </div>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4 text-center">
                        <h3>{{ valid_compliance_count or 0 }}</h3>
                        <p class="text-success">Valid</p>
                    </div>
                    <div class="col-md-4 text-center">
                        <h3>{{ expiring_soon_count or 0 }}</h3>
                        <p class="text-warning">Expiring Soon</p>
                    </div>
                    <div class="col-md-4 text-center">
                        <h3>{{ expired_count or 0 }}</h3>
                        <p class="text-danger">Expired</p>
                    </div>
                </div>
                
                <div class="progress mt-3" style="height: 30px;">
                    <div class="progress-bar bg-success" style="width: {{ (valid_compliance_count / total_vehicles * 100) if total_vehicles > 0 else 0 }}%">
                        {{ "%.1f"|format((valid_compliance_count / total_vehicles * 100) if total_vehicles > 0 else 0) }}%
                    </div>
                    <div class="progress-bar bg-warning" style="width: {{ (expiring_soon_count / total_vehicles * 100) if total_vehicles > 0 else 0 }}%">
                        {{ "%.1f"|format((expiring_soon_count / total_vehicles * 100) if total_vehicles > 0 else 0) }}%
                    </div>
                    <div class="progress-bar bg-danger" style="width: {{ (expired_count / total_vehicles * 100) if total_vehicles > 0 else 0 }}%">
                        {{ "%.1f"|format((expired_count / total_vehicles * 100) if total_vehicles > 0 else 0) }}%
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5>Quick Reports</h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <a href="{{ url_for('admin.compliance') }}" class="btn btn-primary">
                        <i class="fas fa-clipboard-check"></i> Compliance Records
                    </a>
                    <a href="{{ url_for('admin.users') }}" class="btn btn-success">
                        <i class="fas fa-users"></i> User Reports
                    </a>
                    <a href="{{ url_for('admin.vehicles') }}" class="btn btn-info">
                        <i class="fas fa-car"></i> Vehicle Reports
                    </a>
                    <a href="{{ url_for('admin.stations') }}" class="btn btn-warning">
                        <i class="fas fa-gas-pump"></i> Station Reports
                    </a>
                </div>
            </div>
        </div>
        
        <div class="card mt-4">
            <div class="card-header">
                <h5>Recent Activity</h5>
            </div>
            <div class="card-body">
                <ul class="list-group list-group-flush">
                    {% for activity in recent_activities[:5] %}
                    <li class="list-group-item">
                        <div class="d-flex justify-content-between">
                            <div>
                                <strong>{{ activity.type }}</strong><br>
                                <small class="text-muted">{{ activity.description }}</small>
                            </div>
                            <div class="text-end">
                                <small class="text-muted">{{ activity.timestamp.strftime('%Y-%m-%d %H:%M') }}</small>
                            </div>
                        </div>
                    </li>
                    {% endfor %}
                </ul>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5>Monthly Compliance Trend</h5>
            </div>
            <div class="card-body">
                <canvas id="complianceChart" width="400" height="100"></canvas>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
function exportCSV() {
    // In a real implementation, this would generate and download a CSV
    alert('CSV export functionality would be implemented here');
}

function exportPDF() {
    // In a real implementation, this would generate and download a PDF
    alert('PDF export functionality would be implemented here');
}

// Initialize chart
document.addEventListener('DOMContentLoaded', function() {
    const ctx = document.getElementById('complianceChart').getContext('2d');
    const chart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
            datasets: [{
                label: 'Valid Compliance',
                data: [12, 19, 3, 5, 2, 3, 15, 18, 14, 12, 10, 15],
                borderColor: 'rgb(75, 192, 192)',
                tension: 0.1
            }, {
                label: 'Expiring Soon',
                data: [2, 3, 5, 2, 8, 3, 4, 2, 5, 3, 4, 2],
                borderColor: 'rgb(255, 205, 86)',
                tension: 0.1
            }, {
                label: 'Expired',
                data: [1, 2, 0, 1, 1, 0, 2, 1, 0, 1, 2, 1],
                borderColor: 'rgb(255, 99, 132)',
                tension: 0.1
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
});
</script>
{% endblock %}